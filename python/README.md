# バックエンド(Python)
画像認識や表情推定の機能を提供するバックエンドです．

## 担当
- ichigo
- zawa

| 担当者    | 内容                                        |
|--------|-------------------------------------------|
| ichigo | PythonAPIの実装（画像処理・顔検出・感情分析・リコメンドアイスの選択）   |
| zawa   | ロゴ認識の実装（テンプレートマッチング・現在赤色領域の検出なのををロゴ認識に変更） |

## 実行方法
以下のコマンドでバックエンドを起動します．
仮想環境を起動していること前提です．
```bash
pip install --no-cache-dir -r requirements.txt
python3 app.py
```
他のフロントエンドやGoAPIやインフラと共に実行する場合は以下のコマンドを実行してください．
```bash
docker compose up
```
docker composeの初回実行時は以下のコマンドを実行してください．
```bash
docker compose up --build
```
## ディレクトリ構成
```
python/
├── __init__.py
├── run.py
├── utils.ppython
├── template.py
├── routes/
│   ├── __init__.py
│   ├── analyze.py
│   └── detect.py
└── logo.png
```
## requirements.txt
Pythonバックエンドの依存関係が記述されています．何かライブラリを追加した場合はこのファイルにライブラリを記載してください．

## app.py
バックエンドのエントリーポイントです．


## __init__.py
プロジェクト直下に配置されるこのファイルは，Flask アプリケーションのインスタンスを生成し，必要な設定および Blueprint の登録を行うためのものである．

- **内容**
    - ログ設定および boto3 のロガー設定を行っている．
    - `create_app()` 関数内で Flask アプリケーションを生成し，`routes/analyze.py` と `routes/detect.py` の Blueprint を登録している．

- **備考**  
  このファイルは，アプリケーション全体の設定および初期化に関する中心的な役割を担っている．

---

## app.py
アプリケーションのエントリーポイントとなるファイルである．

- **内容**
    - `__init__.py` から `create_app()` 関数をインポートし，Flask アプリケーションのインスタンスを生成している．
    - 環境変数 `PORT` を参照し，指定がない場合はデフォルトのポート 8000 でアプリケーションを実行するようになっている．

- **備考**  
  このファイルを実行することで，Flask アプリケーションが起動する仕組みである．

---

## utils.py
画像処理に関する共通のユーティリティ関数を定義するファイルである．

- **内容**
    - `decode_base64_image(image_data: str)`  
      Base64 エンコードされた画像データ（プレフィックスなし）をデコードし，NumPy 配列として OpenCV で扱える画像に変換する．
    - `get_red_contours(image)`  
      入力された BGR 画像から赤色領域の輪郭を抽出するための処理を実装している．

- **備考**  
  このファイルは，画像のデコードおよび赤色検出など，複数のエンドポイントで共通して使用される処理をまとめたものである．

---

## template.py
ロゴなどのテンプレート画像を読み込み，検出処理で利用するための前処理およびテンプレートマッチングに関する情報を保持するファイルである．

- **内容**
    - テンプレート画像（`logo.png`）をグレースケールとカラーで読み込む処理を実装している．
    - カラー画像から `get_red_contours()` を利用して赤色領域の輪郭を抽出し，その結果をグローバル変数として保持する．
    - テンプレートマッチングおよび赤色形状の類似度評価用の閾値（`tm_threshold` と `red_threshold`）を定義している．

- **備考**  
  テンプレート画像が存在しない場合は，エラーメッセージを出力してプロセスを終了するため，適切な画像が配置されている必要がある．

---

## routes/analyze.py
`/analyze` エンドポイントの処理を実装するファイルである．

- **内容**
    - Blueprint `analyze_bp` を定義して，Flask アプリケーションに `/analyze` のルートが追加されるようにしている．
    - HTTP POST リクエストで受け取った JSON 内の `"image_data"` キーから画像データを取得する．
    - `utils.py` の `decode_base64_image()` を用いて画像をデコードし，OpenCV による顔検出と DeepFace を用いた感情解析を実施する．
    - 検出結果を集計し，最も高い感情スコアの表情を抽出した結果を JSON 形式で返すようにしている．

- **備考**  
  顔検出や感情解析に失敗した場合は，エラーメッセージを返すようにしている．

---

## routes/detect.py
`/detect` エンドポイントの処理を実装するファイルである．

- **内容**
    - Blueprint `detect_bp` を定義して，Flask アプリケーションに `/detect` のルートが追加されるようにしている．
    - HTTP POST リクエストで受け取った JSON 内の `"image_data"` キーから画像データを取得する．
    - `utils.py` の `decode_base64_image()` を用いて画像をデコードし，テンプレート画像（`template.py` で読み込んだもの）とのテンプレートマッチングを実施する．
    - 赤色領域の輪郭を比較し，ロゴが検出されたか否かを評価してその結果を JSON 形式で返すようにしている．

- **備考**  
  閾値や輪郭のマッチング処理に基づき，ロゴが存在するかどうかを判定するロジックを有している．

---

## routes/__init__.py
`routes` ディレクトリをパッケージとして認識させるための空ファイルである．

- **内容**
    - ファイル自体には処理は記述されておらず，パッケージ初期化のための役割を担うだけである．

- **備考**  
  このファイルが存在することで，`routes` 以下の各モジュールが正しくインポートされるようになる．

---

## logo.png
テンプレート画像として利用され，`template.py` で読み込まれる画像ファイルである．

- **内容**
    - 主に `/detect` エンドポイントにおけるロゴ検出処理で使用される．
    - 正しいパスに配置される必要があり，テンプレートマッチングの基準として機能する．

- **備考**  
  ファイル自体は静的な画像であり，画像処理の対象となる．
